name: Deploy SSRS Reports

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ 'Reports/**/*.rdl' ]

jobs:
  deploy-reports:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate RDL files
        run: |
          if (-not (Test-Path ./Reports/*.rdl)) {
            Write-Error "No RDL files found in Reports directory!"
            exit 1
          }
          Get-ChildItem ./Reports/*.rdl | ForEach-Object {
            Write-Host "Found RDL file: $($_.Name)"
          }

      - name: Deploy to SSRS
        env:
          SSRS_URL: "http://laptop-62jj49t4/reportserver"
        run: |
          # Debug: Verify connectivity
          Test-NetConnection -ComputerName laptop-62jj49t4 -Port 80 -InformationLevel Detailed

          # Updated for SQL Server 2022 (version 160)
          $rsPath = "C:\Program Files (x86)\Microsoft SQL Server\160\Tools\Binn\rs.exe"
          
          if (-not (Test-Path $rsPath)) {
            Write-Error "rs.exe not found at $rsPath"
            Get-ChildItem "C:\Program Files (x86)\Microsoft SQL Server\" -Recurse -Filter rs.exe -ErrorAction SilentlyContinue
            exit 1
          }

          foreach ($rdlFile in Get-ChildItem ./Reports/*.rdl) {
            Write-Host "Deploying $($rdlFile.Name)..."
            
            & $rsPath `
              -i $rdlFile.FullName `
              -s $env:SSRS_URL `
              -u "${{ secrets.SSRS_USERNAME }}" `
              -p "${{ secrets.SSRS_PASSWORD }}" `
              -e Exec2022 `  # Updated execution mode
              -v "Overwrite=true" `
              -l 600  # Timeout in seconds

            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to deploy $($rdlFile.Name)"
              exit $LASTEXITCODE
            }
            
            Write-Host "Successfully deployed $($rdlFile.Name)"
          }
