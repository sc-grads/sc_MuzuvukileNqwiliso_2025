name: Deploy SSRS Reports

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ 'Reports/**/*.rdl' ]

jobs:
  deploy-reports:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate RDL files
        run: |
          # Verify RDL files exist
          if (-not (Test-Path ./Reports/*.rdl)) {
            Write-Error "‚ùå No RDL files found in Reports directory!"
            exit 1
          }
          Write-Host "‚úÖ Found RDL files:"
          Get-ChildItem ./Reports/*.rdl | ForEach-Object {
            Write-Host "  - $($_.Name)"
          }

      - name: Deploy via SSRS REST API
        env:
          SSRS_URL: "http://laptop-62jj49t4/Reports/api/v2.0"  # Updated API endpoint
          SSRS_USER: "${{ secrets.SSRS_USERNAME }}"
          SSRS_PASS: "${{ secrets.SSRS_PASSWORD }}"
        run: |
          # Test connectivity
          Write-Host "Testing connection to SSRS server..."
          $pingTest = Test-NetConnection -ComputerName LAPTOP-62JJ49T4 -Port 80 -InformationLevel Quiet
          if (-not $pingTest) {
            Write-Error "‚ùå Cannot reach SSRS server! Check network/firewall."
            exit 1
          }
          Write-Host "‚úÖ Server connection successful"

          # Deploy each report
          $base64Auth = [Convert]::ToBase64String(
            [Text.Encoding]::ASCII.GetBytes("$env:SSRS_USER:$env:SSRS_PASS")
          )
          $headers = @{
            "Authorization" = "Basic $base64Auth"
            "Content-Type" = "application/octet-stream"
          }

          foreach ($rdlFile in Get-ChildItem ./Reports/*.rdl) {
            try {
              Write-Host "üì§ Deploying $($rdlFile.Name)..."
              $bytes = [System.IO.File]::ReadAllBytes($rdlFile.FullName)
              
              $response = Invoke-RestMethod `
                -Uri "$env:SSRS_URL/CatalogItems?Path=%2F$($rdlFile.BaseName)" `
                -Method Post `
                -Headers $headers `
                -Body $bytes

              Write-Host "‚úÖ Success! Report available at:"
              Write-Host "   http://laptop-62jj49t4/Reports?%2F$($rdlFile.BaseName)"
            }
            catch {
              Write-Error "‚ùå Failed to deploy $($rdlFile.Name): $($_.Exception.Message)"
              exit 1
            }
          }
