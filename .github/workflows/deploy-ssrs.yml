name: Deploy SSRS Reports

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ 'Reports/**/*.rdl' ] 

jobs:
  deploy-reports:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Upload RDL files
        run: |
          mkdir -p ./artifacts
          cp ./Reports/**/*.rdl ./artifacts/

      - name: Deploy to SSRS
        run: |
          $ssrsUrl = "http://laptop-62jj49t4/reportserver"
          $username = "${{ secrets.SSRS_USERNAME }}"  # LAPTOP-62JJ49T4\MuzuvukileNqwiliso
          $password = "${{ secrets.SSRS_PASSWORD }}"  # Your Windows password
          
          foreach ($rdlFile in Get-ChildItem ./artifacts/*.rdl) {
            $reportName = [System.IO.Path]::GetFileNameWithoutExtension($rdlFile)
            & "C:\Program Files (x86)\Microsoft SQL Server\150\Tools\Binn\rs.exe" `
              -i $rdlFile.FullName `
              -s $ssrsUrl `
              -u $username `
              -p $password `
              -e Exec2005 `
              -v "Overwrite=true"
          }
