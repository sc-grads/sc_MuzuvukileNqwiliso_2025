name: Deploy SSIS Packages to SQL Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-ssis:
    runs-on: self-hosted

    steps:
    # Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v4

    # Verify repository structure
    - name: Verify repository structure
      run: |
        $projectPath = "C:\actions-runner\_work\sc_MuzuvukileNqwiliso_2025\sc_MuzuvukileNqwiliso_2025\HandsOnProject\Timesheet\MigratingTimesheet"
        if (-not (Test-Path "$projectPath\MigratingTimesheet.dtproj")) {
            Write-Error "SSIS project file not found at expected location: $projectPath"
            exit 1
        }
        Write-Output "Project file found successfully"
        Get-ChildItem -Path $projectPath -Recurse
      shell: powershell

    # Build SSIS Project
    - name: Build SSIS Project
      run: |
        $projectPath = "C:\actions-runner\_work\sc_MuzuvukileNqwiliso_2025\sc_MuzuvukileNqwiliso_2025\HandsOnProject\Timesheet\MigratingTimesheet\MigratingTimesheet.dtproj"
        $outputPath = "C:\actions-runner\_work\SSISOutput"
        
        if (-not (Test-Path $outputPath)) {
            New-Item -ItemType Directory -Path $outputPath -Force
        }
        
        msbuild "$projectPath" /p:Configuration=Release /p:Platform="Any CPU"
        
        if (-not (Test-Path "$outputPath\MigratingTimesheet.ispac")) {
            Write-Error "Build failed - ispac file not created"
            exit 1
        }
        Write-Output "Build completed successfully"
      shell: powershell

    # Deploy SSIS Packages to SQL Server
    - name: Deploy SSIS Packages
      env:
        SQL_SERVER: "LAPTOP-62JJ49T4"
        SSIS_CATALOG: "SSISDB"
        SSIS_FOLDER: "TimesheetDeploy"
        SSIS_PROJECT: "MigratingTimesheet"
      run: |
        # Ensure dtutil is available
        $dtutilPath = "dtutil.exe"
        if (-not (Test-Path $dtutilPath)) {
          Write-Error "dtutil.exe not found. Ensure SQL Server command-line tools are installed on the self-hosted runner."
          exit 1
        }

        # Deploy .ispac file to SSIS Catalog
        $ispacFile = "C:\actions-runner\_work\SSISOutput\MigratingTimesheet.ispac"
        $catalogPath = "/SSISDB/$($env:SSIS_FOLDER)/$($env:SSIS_PROJECT)"

        # Create folder in SSISDB if it doesn't exist
        & $dtutilPath /SQL "$catalogPath" /EXISTS | Out-Null
        if ($LASTEXITCODE -ne 0) {
          & $dtutilPath /SQL "$($env:SSIS_FOLDER)" /CREATE
        }

        # Deploy the .ispac file using Windows Authentication
        & $dtutilPath /FILE "$ispacFile" /DESTServer "$($env:SQL_SERVER)" /COPY SQL;"$catalogPath" /QUIET
      shell: powershell

    # Validate SSIS Deployment
    - name: Validate SSIS Deployment
      env:
        SQL_SERVER: "LAPTOP-62JJ49T4"
        SSIS_CATALOG: "SSISDB"
        SSIS_FOLDER: "TimesheetDeploy"
        SSIS_PROJECT: "MigratingTimesheet"
      run: |
        # Check if the project exists in SSISDB
        $catalogPath = "/SSISDB/$($env:SSIS_FOLDER)/$($env:SSIS_PROJECT)"
        & dtutil.exe /SQL "$catalogPath" /EXISTS
        if ($LASTEXITCODE -eq 0) {
          Write-Output "SSIS Project $($env:SSIS_PROJECT) successfully deployed to $($env:SSIS_CATALOG)/$($env:SSIS_FOLDER)"
        } else {
          Write-Error "Deployment validation failed for $($env:SSIS_PROJECT)"
          exit 1
        }
      shell: powershell
