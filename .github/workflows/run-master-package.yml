name: Deploy SSIS SQL Agent Job

on:
  workflow_call:
  workflow_dispatch:

jobs:
  deploy-ssis-job:
    runs-on: self-hosted
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify SQL Server connection
        shell: powershell
        run: |
          $sqlServer = "LAPTOP-62JJ49T4"
          Write-Output "Testing SQL Server connection with Windows Auth..."
          $testQuery = "SELECT @@SERVERNAME AS ServerName, SYSTEM_USER AS CurrentUser"
          $result = sqlcmd -S $sqlServer -E -Q "$testQuery"
          if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to connect to SQL Server using Windows Auth"
              exit 1
          }
          Write-Output "Connection successful:"
          Write-Output $result

      - name: Create SQL Agent Job
        shell: powershell
        run: |
          # Configuration
          $sqlServer = "LAPTOP-62JJ49T4"
          $jobName = "Run_SSIS_MasterPackage"
          $ssisPath = "\TimesheetDeploy\MigratingTimesheet\MasterPackage.dtsx"
          $scheduleName = "Timesheet_Migration_Schedule"
          $ownerLogin = "LAPTOP-62JJ49T4\MuzuvukileNqwiliso"

          # Build the SSIS execution command (escape single quotes for T-SQL string)
          $command = "/ISSERVER `"\SSISDB$ssisPath`" /SERVER `"$sqlServer`" /Par `"`$ServerOption::SYNCHRONIZED(Boolean)`";True /CALLERINFO SQLAGENT /REPORTING E"
          $escapedCommand = $command -replace "'","''"

          # Compose SQL batch as a single-line string
          $sql = "USE [msdb]; " +
                 "IF EXISTS (SELECT 1 FROM msdb.dbo.sysjobs WHERE name = N'$jobName') " +
                 "BEGIN EXEC msdb.dbo.sp_delete_job @job_name = N'$jobName', @delete_unused_schedule = 1; PRINT 'Deleted existing job: $jobName'; END; " +
                 "EXEC msdb.dbo.sp_add_job @job_name = N'$jobName', @description = N'Automated SSIS package execution (every 1 minute)', @owner_login_name = N'$ownerLogin'; " +
                 "EXEC msdb.dbo.sp_add_jobstep @job_name = N'$jobName', @step_name = N'Execute_SSIS_Package', @subsystem = N'SSIS', @command = N'$escapedCommand', @database_name = N'SSISDB'; " +
                 "IF NOT EXISTS (SELECT 1 FROM msdb.dbo.sysschedules WHERE name = N'$scheduleName') " +
                 "BEGIN EXEC msdb.dbo.sp_add_schedule @schedule_name = N'$scheduleName', @freq_type = 4, @freq_interval = 1, @freq_subday_type = 4, @freq_subday_interval = 1, @active_start_time = 000000; END; " +
                 "EXEC msdb.dbo.sp_attach_schedule @job_name = N'$jobName', @schedule_name = N'$scheduleName'; " +
                 "EXEC msdb.dbo.sp_add_jobserver @job_name = N'$jobName', @server_name = @@SERVERNAME; " +
                 "PRINT 'Successfully created job: $jobName';"

          # Run the SQL command with error handling
          Write-Output "Creating SQL Agent Job..."
          sqlcmd -S $sqlServer -E -Q $sql -b -r 1
          if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to create SQL Agent Job"
              exit 1
          }

          Write-Output "Successfully deployed SQL Agent Job '$jobName' with schedule '$scheduleName' (runs every 1 minute)"
