name: Deploy SSIS SQL Agent Job

on:
  workflow_call:
  workflow_dispatch:

jobs:
  deploy-ssis-job:
    runs-on: self-hosted
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create 1-Minute SQL Agent Job
        shell: powershell
        run: |
          # Configure variables
          $sqlServer = "LAPTOP-62JJ49T4"
          $jobName = "Run_SSIS_MasterPackage"
          $ssisFolder = "TimesheetDeploy"
          $ssisProject = "MigratingTimesheet"
          $ssisPackage = "MasterPackage.dtsx"
          $ownerLogin = "LAPTOP-62JJ49T4\MuzuvukileNqwiliso"
          $scheduleName = "Timesheet_Migration_Schedule"

          # Build SSIS command with proper escaping
          $escapedCommand = "/ISSERVER ""\SSISDB\$ssisFolder\$ssisProject\$ssisPackage"" /SERVER ""$sqlServer"" /Par ""`$ServerOption::SYNCHRONIZED(Boolean)"";True /CALLERINFO SQLAGENT /REPORTING E"

          # T-SQL script with proper escaping
          $sql = @"
          USE [msdb];
          
          IF EXISTS (SELECT job_id FROM msdb.dbo.sysjobs WHERE name = N'$jobName')
            EXEC msdb.dbo.sp_delete_job @job_name = N'$jobName';

          EXEC msdb.dbo.sp_add_job 
              @job_name = N'$jobName',
              @description = N'Runs SSIS MasterPackage every 1 minute',
              @owner_login_name = N'$ownerLogin';

          EXEC msdb.dbo.sp_add_jobstep
              @job_name = N'$jobName',
              @step_name = N'Execute_SSIS_Package',
              @subsystem = N'SSIS',
              @command = N'$($escapedCommand.Replace("'","''"))',
              @database_name = N'SSISDB';

          IF NOT EXISTS (SELECT 1 FROM msdb.dbo.sysschedules WHERE name = N'$scheduleName')
          EXEC msdb.dbo.sp_add_schedule
              @schedule_name = N'$scheduleName',
              @freq_type = 4,
              @freq_interval = 1,
              @freq_subday_type = 4,
              @freq_subday_interval = 1,
              @active_start_time = 000000;

          EXEC msdb.dbo.sp_attach_schedule
              @job_name = N'$jobName',
              @schedule_name = N'$scheduleName';

          EXEC msdb.dbo.sp_add_jobserver
              @job_name = N'$jobName',
              @server_name = @@SERVERNAME;
          "@

          # Execute with Windows Authentication
          try {
              $output = sqlcmd -S $sqlServer -E -Q $sql -b
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "SQL command failed with exit code $LASTEXITCODE"
                  Write-Error "Output: $output"
                  exit 1
              }
              Write-Output "Successfully deployed SQL Agent job '$jobName' with schedule '$scheduleName' (runs every 1 minute)"
          }
          catch {
              Write-Error "Failed to create SQL Agent Job: $_"
              exit 1
          }
