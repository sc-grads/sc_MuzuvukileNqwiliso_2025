# name: Deploy SQL Database

# on:
#   workflow_dispatch:

# jobs:
#   run-sql:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       - name: Verify SQL file exists
#         run: |
#           if [ -f "HandsOnProject/Timesheet/SQL Scripts/CreateDatabase.sql" ]; then
#             echo "SQL file found"
#           else
#             echo "SQL file NOT found"
#             exit 1
#           fi

#       - name: Run SQL Script with Docker
#         env:
#           SQL_SERVER: ${{ secrets.SQL_SERVER }}
#           SQL_USER: ${{ secrets.SQL_USER }}
#           SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
#         run: |
#           echo "Starting SQL execution at $(date)"
#           docker run --rm -v $(pwd):/work mcr.microsoft.com/mssql/server:2019-latest \
#             bash -c "echo 'Running sqlcmd' && /opt/mssql-tools18/bin/sqlcmd -S ${SQL_SERVER} -U ${SQL_USER} -P '${SQL_PASSWORD}' -C -b -t 30 -i '/work/HandsOnProject/Timesheet/SQL Scripts/CreateDatabase.sql'"
#           echo "Finished at $(date)"

#   call-ssis:
#     needs: run-sql
#     uses: ./.github/workflows/deploy-ssis.yml
#     secrets: inherit

name: Deploy SQL Database and Trigger SSIS Deploy

on:
  workflow_dispatch:

jobs:
  run-sql:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Verify SQL file exists
        shell: powershell
        run: |
          if (-Not (Test-Path "HandsOnProject\Timesheet\SQL Scripts\CreateDatabase.sql")) {
            Write-Error "SQL file NOT found"
            exit 1
          }
          Write-Output "SQL file found"

      - name: Run SQL Script using sqlcmd with Windows Auth
        shell: powershell
        run: |
          $sqlServer = "YOUR_SQL_SERVER_NAME"
          $sqlFile = "HandsOnProject\Timesheet\SQL Scripts\CreateDatabase.sql"
          Write-Output "Starting SQL execution at $(Get-Date)"
          & sqlcmd.exe -S $sqlServer -E -i $sqlFile -b
          Write-Output "Finished SQL execution at $(Get-Date)"

  call-ssis:
    needs: run-sql
    uses: ./.github/workflows/deploy-ssis.yml



